<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title"></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.js"></script> 
    <script src="./vender/vue/vue.min.js"></script>
    <script src="./vender/jquery/jquery-3.5.1.min.js"></script>
    <script src="./js/main.js"></script>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="shortcut icon" href="./pic/commom/browser.ico">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="groupAllList">
    <!-- header開始-->
    @@include('./layout/header.html', { "underline_01": "orange2" })
    <!-- 燈箱開始 -->
    @@include('./layout/login.html')
    <!-- 燈箱結束 -->
    <section class="section1 bgcColor">
        <div class="wrap">
            <div class="grouninfostyle">
                <div class="level11 green1">
                    揪團露營
                </div>
                <div>
                    <a href="#" class="startNewGroup" onclick="startNewGroup()"><button class="mainbtn1">我要開團</button><img src="./pic/group/newgroup-01.svg" alt=""></a>
                </div>
            </div>
            
            
            <div class="breadcrumbs">
                <ul>
                    <li><a href="./shansen.html"  class="level0 green1">首頁</a></li>
                    <li><a href="./group.html"  class="level0 green1">揪團露營</a></li>
                    <li class="level0 gray1" id="thisPage"></li>
                </ul>
            </div>
            <!-- 檢舉lightbox -->
            <div class="report_overlay">
                <article>
                    <form class="report_form" action="">
                        <div class="level7 bold green1 report_title">檢舉原因</div>                        
                        <div class="report_reason1 level1 gray1">
                            <input type="radio" name="reason0" id="report_equ1">
                            <label for="report_equ1">1</label>
                        </div>
                        <div class="report_reason2 level1 gray1">
                            <input type="radio" name="reason0" id="report_equ2">
                            <label for="report_equ2">2</label>
                        </div>
                        <div class="report_reason3 level1 gray1">
                            <input type="radio" name="reason0" id="report_equ3">
                            <label for="report_equ3">3</label>
                        </div>
                        <div class="report_close_btn">
                            <input class="thirdbtn1_green submit_btn" type="submit" name="SB" value="送出">
                            <button type="button" class="thirdbtn1_green btn_modal_close">取消</button>
                        </div>                                        
                    </form>                      
                </article>
            </div>
            <div class="groupMain">
                <div class="groupBlock groupBlockI">
                    <div class="ginside group gray1 ">
                        <!-- <div class="hot">
                            <p class="white">熱門景點</p>
                        </div> -->
                        <div class="gLeft">
                            <div class="pic picI">
                                <label class="uploadImg ginsideImg uploadImgI">
                                    <!-- <input type="file" id="theFile"> -->
                                    <img id="pic1" alt="" class="nowPic">
                                </label>
                                <div class="imgs">
                                    <div class="img now"><img id="pic2" alt=""></div>
                                    <div class="img"><img id="pic3" alt=""></div>
                                    <div class="img"><img id="pic4" alt=""></div>
                                </div>
                            </div>
                            <div class="maphashtagI maphashtag ">
                                <input type="submit" class="tagbtn_green" id="county">
                                <input type="submit" class="tagbtn_green" id="camName">
                            </div>
                            
                        </div>
                        <div class="gRight">
                            <div class="headLine">
                                <h3 class="level7 green1" id="GROUPNAME"></h3>
                                <div class="smallInfo">
                                    <h6 class="level0 gray1" id="GROUP_START_DATE"></h6>
                                    <input type="submit" class="reportbtngGroup" value="檢舉" id="report">

                                </div>
                            </div>
                            <fieldset class="poster_inform">
                                <legend class="level1 green3 poster">主揪</legend>
                                <!-- <h4 class="third_title poster">主揪</h4> -->
                                <div class="inform_block">
                                    <div class="inform_pic">
                                           <img id="MEMIMG" alt="">
                                    </div>
                                    <div class="inform_text">
                                        <h4 class="third_title" id="MEMNICKNAME"></h4>
                                    </div>                                                                     
                                </div>
                            </fieldset>
                            <span>相關介紹 :</span>
                            <p class="info infomore" id="GROUP_INTRO">
                            </p>
                            <p id="GROUP_DEPART_DATE">
                            </p>
                            <p id="GROUP_DEADLINE">
                            </p>
                            <div class="aboutPepole">
                                <div>
                                    <p id="GROUP_PEOPLE_LIMIT">
                                        <span>人數上限 :</span> {{limPepole}}人
                                    </p>
                                </div>
                                <div class="right">
                                    <p class="note" id="REMAIN_PEOPLE">
                                        <!-- 目前只剩{{leastPepole}}個名額囉~ -->
                                    </p>
                                </div>
                                
                            </div>
                            <div class="equthing">
                                <span>須具備設備 :</span>
                                <div id="equthing">
                                </div>
                            </div>
                            <div  id="forBtn">
                                <input type="submit" value="我要參加" id="joinGroup">
                            </div>
                        </div>
                    </div>     
                </div>
            </div>
        </div>
    </section>
    <!-- 團員 -->
    <section class="section2 bgcColor gray1">
        <div class="wrap">
            <div class="level11 green1">
                參加團員
            </div>
            <div class="gPepole groupBlock" id="memberIn">

            </div>
        </div>
    </section>
    <!-- 留言 -->
    <section class="section2 bgcColor gray1">
        <div class="wrap">
            <div class="level11 green1">
                留言
                <div class="gPepole groupBlock gMessage" id="massages">
      
                </div>
                <div class="myMsg level5">
                    我要留言
                    <div>
                        <textarea name="" class="inputstyle" id="leaveMsg" cols="60" rows="3" placeholder="任何想說或是想問的嗎?" ></textarea>
                        <input type="submit" value="送出" class="thirdbtn1_green" id="sendMsg">
                    </div>
                    
                </div>
                

            </div>
        </div>
    </section>
    
    <!-- 其他 -->
    <section class="section2 moreGroups bgcColor gray1">
        <div class="wrap">
            <div class="level11 green1">
                你可能感興趣的揪團
            </div>
            <div class="gPepole groupBlock moreGroups">
                <button class="tagbtn_yellow" id="leftBtn">&lt;</button>
                <div class="oGroups">
                    <ul class="allGroup" id="allGroup">
                    </ul>
                </div>
                <button class="tagbtn_yellow" id="rightBtn">&gt;</button>
            </div>
        </div>
    </section>

    <!-- footer 開始-->
    @@include('./layout/footer.html')
    <!-- footer 結束-->

    </div>
    <script src="./js/logintext.js"></script>
    <script src="./js/normalFunc.js"></script>
    <script>
        // function $id(id){
        //     return document.getElementById(id);
        // }
        // function $create(tag){
        //     return  document.createElement(tag);
        // }
        // function $append(father,child){
        //     return  father.appendChild(child);
        // }
        // function formatDate(date) {  
        //     var y = date.getFullYear();  
        //     var m = date.getMonth() + 1;  
        //     m = m < 10 ? ('0' + m) : m;  
        //     var d = date.getDate();  
        //     d = d < 10 ? ('0' + d) : d;  
        //     var h = date.getHours();  
        //     var minute = date.getMinutes();  
        //     minute = minute < 10 ? ('0' + minute) : minute;
        //     var s =  date.getSeconds();
        //     return y + '-' + m + '-' + d+' '+h+':'+minute+':'+s;  
        // }; 
        
        //參加團員
        function peopleIn(){
            let memberIn=$id("memberIn");
            if(groupsdata[2]==""){
                memberIn.innerText = "目前尚無人參加";
                memberIn.style.textAlign="center";
                memberIn.className+=" green1 level5";
            }
            else{
                for(let i=0; i<groupsdata[2].length ;i++){
                    let inform_block =$create("div");
                    inform_block.className="inform_block";
                    if(groupsdata[2].length>4){
                        inform_block.style["margin-bottom"] = "10px";
                    }
                    $append(memberIn,inform_block);
                    let inform_pic = $create("div");
                    inform_pic.className =  "inform_pic";
                    $append(inform_block,inform_pic);
                    let img = $create("img");
                    img.src = "./pic/member/"+groupsdata[2][i].MEM_IMG;
                    $append(inform_pic,img);
                    let inform_text = $create("div");
                    inform_text.className =  "inform_text";
                    $append(inform_block,inform_text);
                    let h4 = $create("H4");
                    h4.className ="third_title";
                    h4.innerText = groupsdata[2][i].MEM_NICKNAME;
                    $append(inform_text,h4);
                }
            }
        }
        //設備
        function getEQU(){
            let equthing = $id(`equthing`);
            console.log(groupsdata);
            if(groupsdata[3] == "沒資料"){
                equthing.innerText = "此團無須自備設備";
                equthing.style.fontSize ="16px";
            }else{
                let a;
                for(let j=0; j<groupsdata[3].length ; j++){
                    a=$create("a");
                    a.className="equ";
                    a.innerHTML = ` <button class="tagbtn_yellow">${groupsdata[3][j].EQUSORT_EQUNAME}</button>`;
                    $append(equthing,a);
                }
                let p = $create("p");
                p.className = "gray2";
                p.innerText = "(標籤可到設備交換區)"
                $append(equthing,p);
                
            }
        }
        //其他揪團
        function othergroups(){
            let allGroup = $id("allGroup");
            for(let i=0;i<groupsdata[4].length;i++){
                let li=$create("li");
                li.className="group";
                li.innerHTML=`
                <div class="img">
                    <img src="./pic/group/${groupsdata[4][i].GROUP_PIC1}" alt="圖片出問題">
                </div>
                <div class="info ">
                    <div class="gName level5 green1">
                        ${groupsdata[4][i].GROUP_NAME}
                    </div>
                    <div class="btns">
                        <div class="maphashtagI maphashtag">
                            <input type="submit" class="tagbtn_green" value="${groupsdata[4][i].CAM_COUNTY}">
                            <input type="submit" class="tagbtn_green" value="${groupsdata[4][i].CAM_NAME}">
                        </div>
                        <div class="more">
                            <a href="./groupInfo.html?GROUP_NO=${groupsdata[4][i].GROUP_NO}"><input type="submit" class="secondbtn1" value="查看詳情"></a>
                        </div>
                    </div>
                </div>
                `;
                $append(allGroup,li);
            }
        }
        //揪團
        function showgroupinfo(){
            $id("thisPage").innerText = groupsdata[0].GROUP_NAME;
            $id("title").innerText = groupsdata[0].GROUP_NAME;
            $id("pic1").src ="./pic/group/"+groupsdata[0].GROUP_PIC1;
            $id("pic2").src ="./pic/group/"+groupsdata[0].GROUP_PIC1;
            $id("pic3").src ="./pic/group/"+groupsdata[0].GROUP_PIC2;
            $id("pic4").src ="./pic/group/"+groupsdata[0].GROUP_PIC3;
            $id("county").value=groupsdata[0].CAM_COUNTY;
            $id("camName").value=groupsdata[0].CAM_NAME;
            $id("GROUPNAME").innerText = groupsdata[0].GROUP_NAME;
            $id("GROUP_START_DATE").innerText = "開團時間 :" + groupsdata[0].GROUP_START_DATE;
            $id("MEMIMG").src ="./pic/member/"+groupsdata[0].MEM_IMG;
            $id("MEMNICKNAME").innerText = groupsdata[0].MEM_NICKNAME;
            $id("GROUP_INTRO").innerText = groupsdata[0].GROUP_INTRO;
            $id("GROUP_DEPART_DATE").innerHTML = "<span>出團日期 :</span>"+groupsdata[0].GROUP_DEPART_DATE;
            $id("GROUP_DEADLINE").innerHTML = "<span>結束日期 :</span>"+groupsdata[0].GROUP_DEADLINE;
            $id("GROUP_PEOPLE_LIMIT").innerHTML ="<span>人數上限 :</span>"+groupsdata[0].GROUP_PEOPLE_LIMIT+"人";
            $id("REMAIN_PEOPLE").innerHTML ="目前剩下"+groupsdata[0].REMAIN_PEOPLE+"個名額囉~";
            let forBtn = $id("forBtn");
            let joinGroupBtn = $id("joinGroup");
            let report = $id("report");
            if(member.MEMNO == groupsdata[0].GROUP_MEMNO){
                //若是主揪:關閉此團，關閉檢舉
                joinGroupBtn.value = "關閉此團";
                joinGroupBtn.className = "secondbtn2";
                forBtn.style["text-align"] = "right";
                report.style["display"] = "none";
                // console.log(member.MEMNO); 
                // console.log(groupsdata[0].GROUP_MEMNO);  
            }else{
                //若是參團者:我要退團，關閉檢舉
                joinGroupBtn.className = "mainbtn1";
                forBtn.style["text-align"] = "center";
                for(let i=0; i< groupsdata[2].length; i++){
                    if(member.MEMNO == groupsdata[2][i].G_DETAIL_MEMNO){
                        joinGroupBtn.value = "我要退團";
                        joinGroupBtn.className = "secondbtn2";
                        forBtn.style["text-align"] = "right";
                        report.style["display"] = "none";
                        break;
                    }
                }
            }

        }
        //已留言
        function showMsg(){
            let massages = $id("massages");
            massages.innerHTML="";
            if(groupsdata[1]==""){
                let msgInfo = $create("div");
                msgInfo.className="msgInfo green1 level5";
                msgInfo.innerText="尚未有人留言";
                msgInfo.style.textAlign="center";
                msgInfo.style.display="block";
                msgInfo.style["font-weight"]="normal";
                $append(massages,msgInfo);    
            }else{
                for(let i=0; i<groupsdata[1].length ;i++){
                    let msgInfo = $create("div");
                    msgInfo.className="msgInfo";
                    if(groupsdata[1][i].GROUP_MES_MEMNO==groupsdata[0].GROUP_MEMNO){
                        msgInfo.className+=" grouper";
                    }
                    msgInfo.innerHTML=`<div class="inform_block">
                            <div class="inform_pic">
                                    <img src="./pic/member/${groupsdata[1][i].MEM_IMG}" alt="">
                            </div>
                            <div class="inform_text">
                                <p class="green1 third_title">${groupsdata[1][i].MEM_NICKNAME}</p>
                            </div>                                                                      
                        </div>
                        <div class="level1">
                            <span class="third_title">留言:</span>
                            <p class="gray1">${groupsdata[1][i].GROUP_MES_CONTENT}</p>
                        </div>
                        <div class="level0 gray1">
                            留言時間:${groupsdata[1][i].GROUP_MES_TIME} 
                        </div>
                        <input type="hidden" value="${groupsdata[1][i].GROUP_MES_NO}">
                        
                    </div>`;                    
                    $append(massages,msgInfo);
                    let input = $create("input");
                        input.type = "submit";
                        input.className ="reportbtnMsg";
                    if(groupsdata[1][i].GROUP_MES_MEMNO==member.MEMNO){
                        // <input type="submit" class="reportbtnMsg" value="檢舉">
                        input.value="刪除";
                    }else{
                        input.value="檢舉";
                    }
                    $append(msgInfo,input);
                }
            }
            
        }
        function readPage(groupNo){
            let groupxhr = new XMLHttpRequest();
            groupxhr.onload = function(){
                if(groupxhr.status == 200){ //success
                    groupsdata = JSON.parse(groupxhr.responseText);
                    showgroupinfo();
                    getEQU();
                    peopleIn();
                    showMsg();
                    othergroups();
                    // //檢舉留言
                    var reportbtngGroup = document.querySelector(".reportbtngGroup");
                    reportbtngGroup.addEventListener("click", function() { report() });

                    var reportbtnMsg = document.querySelectorAll(".reportbtnMsg");
                    for(let i =0; i<reportbtnMsg.length; i++){
                        reportbtnMsg[i].addEventListener("click", function() { report("reportbtnMsg") });
                    }
                    //留言
                    let leaveMsg = $id("sendMsg");
                    leaveMsg.addEventListener("click", function (){
                        if(member.MEM_ID){
                            var leaveMsg =document.querySelector("#leaveMsg").value;
                            if(leaveMsg.trim()!= ""){
                                let date = formatDate(new Date());
                                let msgxhr = new XMLHttpRequest();
                                msgxhr.onload = function(){
                                    if(msgxhr.status == 200){ //success 
                                        // location.reload(); 
                                        leaveMsg = "";
                                        showMsg();
                                    }else{
                                        alert(msgxhr.responseText);
                                    }  
                                }
                                msgxhr.open("Post", "./php/group/leaveMsg.php", true);
                                msgxhr.setRequestHeader("content-type","application/x-www-form-urlencoded");
                                let data_info = `GROUP_MES_GROUPNO=${groupsdata[0].GROUP_NO}&GROUP_MES_MEMNO=${member.MEMNO}&GROUP_MES_TIME=${date}&GROUP_MES_CONTENT=${leaveMsg}`;
                                msgxhr.send(data_info);
                            }else{
                                alert("請輸入文字再送出~");
                            }
                            
                        }else{
                            showLoginForm();
                        }
                    });
                }else{ //error
                    alert(groupxhr.responseText);
                }
            }
            groupxhr.open("get", `./php/group/groupInfo.php?GROUP_NO=${groupNo}`, true);
            groupxhr.send(null);
        }
        function doFirst(){
            var url = location.href;
            if(url.indexOf('?')!=-1){
                var GROUP_NO = url.split('?')[1].split('=');
                readPage(GROUP_NO[1]);
    
            }else{
                alert("連結錯誤，請選別頁");
            }

        }
        window.addEventListener('load',doFirst);
    </script>

    <script>
        let imgCount ='';
        let divWidth='';
        let allwidth='';
        let count=0;
        $(window).resize(function(){
            divWidth = $('.oGroups').width(); 
            if(divWidth == 880){
                $('.allGroup').width(Math.ceil(imgCount / 2) * divWidth);
                allwidth =(Math.ceil(imgCount / 2));
            }else{
                $('.allGroup').width(Math.ceil(imgCount) * divWidth);
                allwidth =(Math.ceil(imgCount));
            }
            count=1;
            $('.allGroup').animate({
                    right: divWidth * count,
            });
        });
         
        $(setTimeout(function(){
            //要更換的圖片位置
            $('.pic .imgs .img img').click(function(){ 
                let mig = $(this).attr("src");
                $('.pic .imgs .img').removeClass("now");
                $(this).parent().addClass("now");
                $(".nowPic").attr("src", mig);      
            });   
            // 燈箱
            $(".btn_modal_close").on("click", function(){
                $(".report_overlay").addClass("-opacity-zero");
                $("input[name=reason0]").each(function(){
                    $(this).prop("checked",false);//把所有的核方框的property都取消勾選
                }); 
                setTimeout(function(){
                    $(".report_overlay").removeClass("-on -opacity-zero");
                }, 1000);
            }); 
            //更多揪團
            imgCount = $('.allGroup .group').length;
            divWidth = $('.oGroups').width(); 
            if(divWidth == 880){
                $('.allGroup').width(Math.ceil(imgCount / 2) * divWidth);
                allwidth =(Math.ceil(imgCount / 2));
            }else{
                $('.allGroup').width(Math.ceil(imgCount) * divWidth);
                allwidth =(Math.ceil(imgCount));
            }
                
            
            if(allwidth ==1){
                $('#leftBtn').hide();
                $('#rightBtn').hide();
            }else{
                $('#leftBtn').click(function(){
                if(count == 0){
                    $('#leftBtn').css('background-color', '#C4C4C4');
                    $('#leftBtn').css('border-color', '#C4C4C4');
                    $('#leftBtn').css('border-style', 'inset');
                }
                else{
                    count--; 
                    $('.allGroup').animate({
                        right: divWidth * count,
                    });
                    if(count == 0){
                        $('#leftBtn').css('background-color', '#C4C4C4');
                        $('#leftBtn').css('border-color', '#C4C4C4');
                        $('#leftBtn').css('border-style', 'solid');
                        $('#rightBtn').css('background-color', '#FFCD43');
                        $('#rightBtn').css('border-color', '#FFCD43');
                        $('#rightBtn').css('border-style', 'inset');
                    }

                }
            })
            $('#rightBtn').click(function(){
                if(count < allwidth-1){       
                    count++;
                    $('.allGroup').animate({
                        right: divWidth * count,
                    });
                    if(count == allwidth-1){
                        $('#rightBtn').css('background-color', '#C4C4C4');
                        $('#rightBtn').css('border-color', '#C4C4C4');
                        $('#rightBtn').css('border-style', 'solid');
                    }
                    else{
                        $('#rightBtn').css('background-color', '#FFCD43');
                        $('#rightBtn').css('border-color', '#FFCD43');
                        $('#rightBtn').css('border-style', 'inset');
                    }
                    if(count != 0){
                        $('#leftBtn').css('background-color', '#FFCD43');
                        $('#leftBtn').css('border-color', '#FFCD43');
                        $('#leftBtn').css('border-style', 'inset');
                    }
                }
                
            })
        
            }
        }, 500));       
    </script>
</body>
</html>