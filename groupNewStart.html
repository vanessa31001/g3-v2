<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建立新露營團</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.12/vue.js"></script> 
    <script src="./vender/vue/vue.min.js"></script>
    <script src="./vender/jquery/jquery-3.5.1.min.js"></script>
    <script src="./js/main.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="shortcut icon" href="./pic/commom/browser.ico">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="groupAllList">
    <!-- header開始-->
    <header >
    <div class="forphone">
    <button class="hamburger hamburger--spring" type="button">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>
    </div>
    <nav class="wrap_nav">
        <div class="nav_logo">
            <a class="logo_link -bottom">
                <img class="desk sun" src="./pic/commom/sun.svg" alt="">
            </a>
            <a class="changelogo" href="./shansen.html">
            <img class="phone" src="./pic/commom/phone_header.svg">
            </a>
            <div class="middle_bg"></div>
            <a href="./shansen.html" class="logo_link -up">
                <img class="desk" src="./pic/commom/pc_header.svg">
            </a>
        </div>
        <div class="nav_list">
            <ul >
                <li><a class="nav_title orange2" href="./group.html">揪團露營</a></li>
                <li><a class="nav_title @@underline_02" href="./equipment.html">設備交換</a></li>
                <li><a class="nav_title @@underline_03" href="./camping.html">營區攻略</a></li>
                <li><a class="nav_title @@underline_04" href="./letter.html">來去寫信</a></li>
                <li><a class="nav_title @@underline_05" href="./aboutus.html">關於我們</a></li>
                <li><a href="./member.html" id="header_memName">&nbsp;</a>
                    <a class="nav_title @@underline_06" id="spanLogin">登入|註冊</a>
                </li>
            </ul>
        </div>
    </nav>
</header>
    <!-- 燈箱開始 -->
    <div id="outerDiv">
    <div id="lightBox">
        <input type="checkbox" id="login_img_control" name="login">
        <div class="login_container">
            <div id="logiMember">
                <table border="1" align="center" cellspacing="0" id="tableLogin" class="login_block_left">
                    <tr><td colspan="2" align="center"><a href="./shansen.html"  class="logo_link_logo">
                        <img class="login_logo"  style="width: 75px;padding: 20px 5px 10px 0px;" src="./pic/commom/1017_logo.png" alt="">
                    </a></td></tr>
                    <tr><td colspan="2" align="center" class="sub_title">會員登入</td></tr>
                    <tr><td>帳號：</td><td><input class="inputstyle" type="text" name="memId" id="LoginMemId" placeholder="請輸入您的Email"></td></tr>
                    <tr><td>密碼：</td><td><input class="inputstyle" type="password" name="memPsw" id="LoginMemPsw" placeholder="請輸入密碼(6-20英數字)"></td></tr>
                    <tr><td colspan="2" align="center">
                        <input type="button" id="btnLogin" value="登入" class="thirdbtn1_green">  
                        <input type="button" id="btnLoginCancel" value="取消" class="thirdbtn2_green">  
                    </td></tr>
                    <tr><td colspan="2" align="center" class="level1">
                        <p id="forgetPsw">忘記密碼?</p>
                        <label for="login_img_control">
                            <span id="to_register_btn">還沒申請帳號?</span>
                        </label>
                    </td></tr>
                </table>
            </div>
            <form id="reiMember">
                <table align="center" cellspacing="0" id="register" class="login_block_right">
                    <tr><td colspan="2" align="center"><a href="./shansen.html" class="logo_link_logo">
                        <img class="login_logo"  style="width: 75px;padding: 20px 5px 10px 0px;" src="./pic/commom/1017_logo.png" alt="">
                    </a></td></tr>
                    <tr><td colspan="2" align="center" class="sub_title">註冊會員</td></tr>
                    <tr><td>會員帳號：</td><td><input class="inputstyle" type="text" name="memId" id="RegiMemId" placeholder="請輸入您的Email"></td></tr>
                    <tr><td>會員密碼：</td><td><input class="inputstyle" type="password" name="memPsw" id="RegiMemPsw" placeholder="請輸入密碼(6-20英數字)"></td></tr>
                    <tr><td>確認密碼：</td><td><input class="inputstyle" type="password" name="memPsw_check" id="RegiDCMemPsw" placeholder="請再次輸入密碼"></td></tr>
                    <tr><td>會員姓名：</td><td><input class="inputstyle" type="text" name="memName" id="RegiMemName" placeholder="請輸入您的姓名"></td></tr>
                    <tr><td>會員暱稱：</td><td><input class="inputstyle" type="text" name="memNice" id="RegiMemNickname" placeholder="請輸入您的暱稱"></td></tr>
                    <tr><td colspan="2" align="center">
                        <input type="button" id="btnRegi" value="註冊" class="thirdbtn1_green">  
                        <input type="button" id="btnRegiCancel" value="取消" class="thirdbtn2_green">  
                    </td></tr>
                    <tr><td colspan="2" align="center" class="level1">
                        <label for="login_img_control">
                            <span id="to_login_btn">已有會員帳號?</span>
                        </label>
                    </td></tr>
                </table>
            </form>
            <div class="login_block_mid">
                <img src="./pic/commom/mid_pic.svg" alt="登入頁照片">
            </div>
        </div>
    </div>
</div>
    <!-- 燈箱結束 -->
        <section class="section1 bgcColor">
            <div class="wrap">
                <div class="level11 green1">
                    建立新露營團
                </div>
                <div class="breadcrumbs">
                    <ul>
                        <li><a href="./shansen.html"  class="level0 green1">首頁</a></li>
                        <li><a href="./group.html"  class="level0 green1">揪團露營</a></li>
                        <li class="level0 gray1">建立新露營團</li>
                    </ul>
                </div>
                <form action="./php/group/createNewGroup.php" class="groupNewStart group"  method="post" enctype="multipart/form-data">
                    <div class="top level7 green1">
                        填寫建團資訊
                    </div>
                    <div class="left">
                        <div class="level1 green1">
                            上傳營地相關照片<span style="color:red;">*</span> :
                        </div>
                        <div class="pic">
                            <label class="uploadImg">
                                <input type="file" id="theFile" name="upFile[]" accept="image/png, image/jpeg" multiple>
                                <img src="pic/equipment/photo-camera.svg" alt="">
                                <span class="level0 gray2">(請上傳三張照片)</span>
                            </label>
                            <div class="imgs">
                                <div class="img" id="img0">
                                </div>
                                <div class="img" id="img1">
                                </div>
                                <div class="img" id="img2">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="right">
                        <div class="infoInput">
                            <div class="level1 gray1">
                                <div class="block">
                                    <div class="green1 level1">露營團名<span style="color:red;">*</span> :</div>
                                    <div><input type="text" class="text inputstyle" placeholder="請為您的團隊取名" id="groupName" name="groupName" ></div>
                                </div>
                                <div class="block">
                                    <div class="green1 textinfo level1">相關介紹<span style="color:red;">*</span> :</div>
                                    <div><textarea id="groupIntro" name="groupIntro" class="inputstyle" cols="40" rows="4" placeholder="可分享營地資訊或心得⋯⋯" ></textarea></div>
                                </div>
                                <div class="block">
                                    <div class="green1 level1" >選擇地區<span style="color:red;">*</span> :</div>
                                    <div>
                                        <select class="inputstyle level1 gray1" id="camArea" name="camArea">
                                        </select>
                                        <select class="inputstyle level1 gray1" id="camName" name="camName">
                                        </select>
                                        <!-- <a href="./camping.html"> -->
                                            <input type="button" id="toCamping" class="thirdbtn2_orange" value="營區參考">
                                        <!-- </a> -->
                                    </div>
                                </div>
                                <div class="block">
                                    <div class="green1 level1">人數上限<span style="color:red;">*</span> :</div>
                                    <div class="level1 gray1"><input type="number" class="inputstyle" placeholder="1" min="1" id="peopleLimit" name="peopleLimit">人(含主揪)</div>
                                </div>
                                <div class="block">
                                    <div class="green1 level1">出團日期<span style="color:red;">*</span> :</div>
                                    <div><input type="date" class="inputstyle level1 gray1" id="startdate" name="startdate"></div>
                                </div>
                                <div class="block">
                                    <div class="green1 level1">結束日期<span style="color:red;">*</span> :</div>
                                    <div><input type="date" class="inputstyle level1 gray1" id="enddate" name="enddate"></div>
                                </div>
                                <div class="block">
                                    <div class="green1 level1">須具備設備 :</div>
                                    <div id="equSort">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="btn" style="text-align: center;">
                            <input type="hidden" name="date" id="nowdate">
                            <!-- <input type="button" class="mainbtn2" value="暫存資料" id="save"> -->
                            <input type="submit" class="mainbtn1" value="發佈" id="create" disabled>
                        </div>
                    </div>

                </form>
            </div>
        </section>
        <!-- footer 開始-->
        <footer>
    <div class="footer_bgc">
        <div class="wrap">
            <div class="footerarrange">
                <div class="footright">
                    <div class="level2 green1">聯絡資訊 |</div>
                    <div class="level0 green1">
                        電子信箱|ShanSen@gmail.com<br>
                        營業時間|週二至週日 10:00~20:00(國定假日休假)
                    </div>
                </div>
                <div class="footercenter">
                    <a href="./shansen.html">
                        <img src="./pic/commom/pc_header.svg">
                    </a>
                </div>
                <div class="footerright">
                    <div class="link">
                        <div class="level2 green1">相關連結 |</div>
                        <div class="footer_icon">
                            <img src="./pic/commom/foot_line.svg" alt="">
                            <img src="./pic/commom/foot_ig.svg" alt="">
                            <img src="./pic/commom/foot_fb.svg" alt="">
                            <img src="./pic/commom/foot_email.svg" alt="">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="copyright">Copyright &copy; 2020ShanSen</div>
</footer>
        <!-- footer 結束-->
    </div>
    <!-- 顯示圖 -->
    <Script>
        $(document).ready(function(){
            //上傳圖片
            $("#theFile").change(function(){
                if (typeof (FileReader) != "undefined") {
                    if($(this)[0].files[2])
                        for (var i = 0; i < 3; i++) {
                            let image_holder= $("#img"+i);
                            image_holder.empty();
                            var reader = new FileReader();
                            reader.onload = function (e) {
                                $("<img />", {
                                    "src": e.target.result,
                                    // "class": "thumb-image"
                                }).appendTo(image_holder);
                            }
                            image_holder.show();
                            reader.readAsDataURL($(this)[0].files[i]);
                        }
                    
                }else {
                    alert("This browser does not support FileReader.");
                }
            });           
        });
    </Script>
    <script src="./js/logintext.js"></script>
    <script src="./js/normalFunc.js"></script>
    <script>
        var GROUP_PIC1="",GROUP_PIC2="",GROUP_PIC3="";
        var groupName = $id("groupName");
        var groupIntro = $id("groupIntro");
        var peopleLimit = $id("peopleLimit");
        var startdate = $id("startdate");
        var enddate = $id("enddate");
        var camArea = $id("camArea");
        var camName = $id("camName");
        var toCamping = $id("toCamping");
        var equSort = $id('equSort');
        var create = $id('create');
        create.style["background-color"]="#C4C4C4";
        create.style["border-color"]="#C4C4C4";
        create.style["color"]="#FFFFFF";
        var equ = document.querySelectorAll(".equ");
        function checkall(){
            // create

            if(GROUP_PIC1 =="" || GROUP_PIC2 =="" || GROUP_PIC3 ==""){
                // swal("請上傳相關圖片");
            }else if(groupName.value.trim()==""){
                // alert("請輸入團名");        
            }else if(groupIntro.value.trim()==""){
                // alert("請輸入介紹");           
            }else if(camArea.value=="" && camName.value==""){
                // alert("請選擇營區");
            }else if(peopleLimit.value=="" || peopleLimit.value <5){
                // alert("請確認人數上限");                   
            }else if(startdate.value==""){
                // alert("請確認出團日期");
            }else if(enddate.value==""){
                // alert("請確認結束日期");
            }else{
                $id("nowdate").value = formatDate(new Date());
                create.disabled= false; 
                create.style["background-color"]="#00A5A3";
                create.style["border-color"]="#00A5A3";
            }
        };
        groupName.addEventListener('blur', function(){
            if(groupName.value.trim()==""){
                swal("請輸入團名"); 
                create.disabled= true; 
                create.style["background-color"]="#C4C4C4";
                create.style["border-color"]="#C4C4C4";
            }else{
                checkall();
            }
        });
        groupIntro.addEventListener('blur', function(){
            if(groupIntro.value.trim()==""){
                swal("請輸入介紹"); 
                create.disabled= true; 
                create.style["background-color"]="#C4C4C4";
                create.style["border-color"]="#C4C4C4";
            }else{
                checkall();
            }
        });
        peopleLimit.addEventListener('blur', function(){
            if(peopleLimit.value <5){
                swal("揪團人數必須大於五人");
                create.disabled= true; 
                create.style["background-color"]="#C4C4C4";
                create.style["border-color"]="#C4C4C4";
            }else{
                checkall();
            }
        });
        startdate.addEventListener('change', function(){
            let now = new Date();
            after7 = now.setDate(now.getDate()+7);
            after7 =formatDate(new Date(after7));
            if(now.getTime()){
                if((Date.parse(startdate.value)).valueOf() < (Date.parse(after7)).valueOf()){
                    startdate.value = "";
                    swal("開團時間必須於七天後，參團者才有時間做準備。");
                    create.disabled= true; 
                    create.style["background-color"]="#C4C4C4";
                    create.style["border-color"]="#C4C4C4";
                }else{
                    checkall();
                }
            }else{
                swal("請輸入 YYYY/MM/DD 格式");
            }
        });
        enddate.addEventListener('change', function(){
            let day = 24 * 60 * 60 * 1000; 
            let startDate = new Date(startdate.value);
            let endDate = new Date(enddate.value);
            if(startDate.getTime() && endDate.getFullYear()){
                if(startDate <= endDate){
                    checkall();
                }else{
                    enddate.value = "";
                    create.disabled= true; 
                    create.style["background-color"]="#C4C4C4";
                    create.style["border-color"]="#C4C4C4";
                    swal("結束日期必須大於出團日期");
                }
            }else{
                enddate.value = "";
                create.disabled= true; 
                create.style["background-color"]="#C4C4C4";
                create.style["border-color"]="#C4C4C4";
                swal("請先輸入出團日期");
            }
        });
        //營區參考
        camArea.onchange = function(){
            listName();
        }
         //暫存存入sessionStorage
         toCamping.addEventListener("click", function(){
                sessionStorage['groupName'] = groupName.value;
                sessionStorage['groupIntro'] = groupIntro.value;
                sessionStorage['peopleLimit'] = peopleLimit.value;
                sessionStorage['startdate'] = startdate.value;
                sessionStorage['enddate'] = enddate.value;
                let equ = document.querySelectorAll(".equ");
                var equss=[];;
                let j=0;
                for(let i=0; i<equ.length; i++ ){
                    if(equ[i].checked){
                        equss[j]=`${i}`;
                        j++;
                    }
                }
                sessionStorage['equSort']=equss;
        });
        function getSession(){
            //顯示sessionStorage
            if(sessionStorage['groupName'] != null || sessionStorage['groupIntro'] != null || sessionStorage['peopleLimit']!= null || sessionStorage['startdate']!= null || sessionStorage['enddate']!= null){
                groupName.value = sessionStorage['groupName'];
                groupIntro.value = sessionStorage['groupIntro'];
                peopleLimit.value = sessionStorage['peopleLimit'];
                startdate.value = sessionStorage['startdate'];
                enddate.value = sessionStorage['enddate'];
                equs=sessionStorage['equSort']; 
                let equ = document.querySelectorAll(".equ");
                for(let i=0; i<equ.length; i++){
                    for(let j=0; j<equs.length; j++){  
                        if(i==equs[j]){
                            equ[i].checked=true;
                        }
                    }
                }
                // for(let i=0; i<3; i++){
                //     // let simg = $id(`img${i}`).querySelector('img');
                //     // alert(sessionStorage[`img${i}`]);
                // }
            }
        }
       
        function saveEQU(equs,groupId){
            for(i=0;i<equs.length;i++){
                let equxhr = new XMLHttpRequest();
                equxhr.onload = function(){
                    if(equxhr.status == 200){ //success 
                        groupId = JSON.parse(equxhr.responseText);
                        console.log(groupId);
                        
                    }else{
                        swal(equxhr.responseText);
                    }  
                }
                equxhr.open("Post", "./php/group/useEQU.php", true);
                equxhr.setRequestHeader("content-type","application/x-www-form-urlencoded");
                let data_info = `GROUP_NO=${groupId}&G_EQU_NO=${equs[i]}`;
                equxhr.send(data_info);
            }
        }
        
        $id("theFile").addEventListener('change', (e) => {
            if(e.target.files[2]){
                GROUP_PIC1 = e.target.files[0].name;
                GROUP_PIC2 = e.target.files[1].name;
                GROUP_PIC3 = e.target.files[2].name;
                checkall()
            }else{
                alert("請上傳三張照片");

            }
            
        });
        // $id("create").addEventListener("click", function(){
        //     let equ = document.querySelectorAll(".equ");
        //     var equs=[];
        //     j=0;
        //     for(let i=0; i < equ.length; i++){
        //         if(equ[i].checked){
        //             equs[j]=equ[i].value;
        //             j++;
        //         }
        //     }
        //     let date = formatDate(new Date());
        //     let msgxhr = new XMLHttpRequest();
        //     msgxhr.onload = function(){
        //         if(msgxhr.status == 200){ //success 
        //             groupId = JSON.parse(msgxhr.responseText);
        //             alert(groupId);
        //             if(equs){
        //                 alert("有設備");
        //                 saveEQU(equs,groupId);
        //             }
                    
        //         }else{
        //             alert(msgxhr.responseText);
        //         }  
        //     }
        //     msgxhr.open("Post", "./php/group/createNewGroup.php", true);
        //     msgxhr.setRequestHeader("content-type","application/x-www-form-urlencoded");
        //     let data_info = `GROUP_NAME=${groupName.value}&GROUP_INTRO=${groupIntro.value}&GROUP_CAM_NO=${camName.value}&GROUP_PEOPLE_LIMIT=${peopleLimit.value}&GROUP_START_DATE=${date}&GROUP_DEADLINE=${enddate.value}&GROUP_DEPART_DATE=${startdate.value}&equs=${equs}&GROUP_PIC1=${GROUP_PIC1}&GROUP_PIC2=${GROUP_PIC2}&GROUP_PIC3=${GROUP_PIC3}`;
        //     // msgxhr.send(data_info);
            
            
        // });
        
        function listEQU(){
           var equSort = $id("equSort");
           for(let i= 0 ; i < city[2].length; i++){
            let label = document.createElement("label");
            label.className ="level1";
            label.innerHTML=`   <input type="checkbox" class="type equ" name="equSort[]" value="${city[2][i].EQUSORT_NO}">
                                ${city[2][i].EQUSORT_EQUNAME}`;
            $append(equSort,label);
            }
        }
        function listName(){
            var camName = $id("camName");
            camName.innerHTML="";
            for(let i= 0 ; i < city[1].length; i++){
                if( city[1][i].CAM_AREA ==camArea.value){
                    let option = document.createElement("option");
                    option.innerText=city[1][i].CAM_NAME;
                    option.value=city[1][i].CAM_NO;
                    $append(camName,option);
                }
            }
        }
        function listArea(){
            var camArea = $id("camArea");
            for(let i=0;i<city[0].length;i++){
                let option = document.createElement("option");
                option.innerText=city[0][i].CAM_AREA;
                option.value=city[0][i].CAM_AREA;
                $append(camArea,option);
            }
            listName();
        }
        function getdata(){//判斷會員
            let areaxhr = new XMLHttpRequest();
            areaxhr.onload = function(){
                if(areaxhr.status == 200){ //success
                    if(!member.MEM_ID){
                        showLoginForm();
                        btnLoginCancel=$id("btnLoginCancel");
                        btnLoginCancel.addEventListener('click',function(){
                            history.go(-1);
                        });
                            // window.location.href='./groupNewStart.html';
                        }
                     city = JSON.parse(areaxhr.responseText);
                    console.log(city);
                    listArea();
                    listEQU();
                    listName();
                    getSession();
                }else{ //error
                    alert(areaxhr.status);
                }
            }
            areaxhr.open("get", `./php/group/area.php`, true);
            areaxhr.send(null);
        }
        function doFirst(){
            getdata();
        }   

        window.addEventListener('load',doFirst);
    </script>
</body>
</html>